<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO App</title>
</head>
<body>


    <!--  Welcoming message-->
    <h1>Welcome to Todo App!</h1>

    <!-- Form to Task Info -->
    <div style="display:flex; gap: 20px;">
        <div style="border: 1px solid black; width:fit-content;">
        <h3 style="padding: 10px;">Add New Task</h3>
        <form id = 'task-form'>
            <div style="padding: 10px;">
                <label for="Title">Title :</label><br>
                <input type="text" id="Title" name="Title"><br>
                <label for="Description">Description :</label><br>
                <textarea name="Description" id="Description" rows="5" cols="30"></textarea><br>
                <label for="Reminder">Set Reminder:</label><br>
                <input type="datetime-local" id="Reminder" name="Reminder">
                <br><br>
                <input type="submit" value="Add Task">
                <button onclick="callGenerateDescription(event)">Generate Description <b>AI</b></button>
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% endwith %}
            </div>
        </form>
        </div>

        <div id ="Notifications" style="border: 1px solid black; width: 300px; display: flex; flex-direction: column; align-items: center;">
            <h3>Notifications</h3>
        </div>
    </div>

    <!-- List of Tasks -->
    <h3>List of Tasks :</h3>
    <div id = "list-group">
     {% for task in todo_list %}
    <div style="border: 1px solid black; padding: 10px;">
    <p id='tasktitle-${task.id}'><b>{{task.id}}</b> | {% if task.isComplete%} <s>{{task.title}}</s> {%else%} {{task.title}} {% endif %}</p>
    
    <p><b><i>Description : </i></b> {{task.description}}</p>

    <span><b><i>Status :</i></b></span> 
    {% if task.isComplete == False %}
    
    <span style="color: red;" >Pending</span>
    {% else %}
    <span style="color: green;">Completed</span>
    {% endif %}
    <br><br>
    <button onclick="updateTaskStatus({{ task.id }})">Update</button>
    <Button onclick="deleteTask({{task.id}})">Delete</Button>
    </div>
    {% endfor %}
</div>
</body>

<!-- Javascript Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
    var socket = io('http://127.0.0.1:5000');

    socket.on('connect', function() {
        socket.emit('my_event', {data: 'I\'m connected!'});
    });

    socket.on("alert", function(data){
        console.log("Alert received", data.task_title, data.task_id)
        showModal(data.task_title, data.task_id, data.task_status)
    })

    function showModal(task_title, task_id, task_status){
        console.log(task_id , task_title )
        if (task_status === false) {
            let Notifications = document.getElementById('Notifications')
            let modal = document.createElement('div');
            modal.classList.add('w3-modal');
            modal.style.display = 'block';
            modal.style.margin = '10px';
            modal.style.border = '1px solid black';
            modal.style.padding = '10px';
            modal.style.width = 'fit-content';
            modal.innerHTML = `
                <div class="w3-modal-content">
                    <div class="w3-container" style = "width: 200px">
                        <h3 id='reminder-${task_id}' style="color: Red; font-weight: bold; align-self: center;">Reminder!</h3>
                        <p id="modalText-${task_id}">Task ${task_id}: ${task_title}</p>
                        <span>
                            <button class="w3-button w3-green" id="doneButton-${task_id}">Done</button>
                        </span>
                        <span>
                            <button class="w3-button w3-red" id="notDoneButton-${task_id}">Not Done</button>
                        </span>
                    </div>
                </div>
            `;
            Notifications.appendChild(modal);

            document.getElementById(`doneButton-${task_id}`).onclick = function() {
                updateTaskStatus(task_id);
                modal.style.display = 'none';
            }
            document.getElementById(`notDoneButton-${task_id}`).onclick = function() {
                modal.style.display = 'none';
            }
        }
    }
    function updateTaskStatus(id){
        console.log("here")
        fetch(`/update_reminder/${id}`).then(response => {
            if(response.ok){
                console.log(response)
                return response.text();
            } else {
                console.error('Failed to update task');
            }
        }).then(data => {
            console.log(data)
            document.getElementById('list-group').innerHTML = data
        }).catch(error => console.error('Error updating task:', error));
    }

    function deleteTask(id){
        fetch(`/delete/${id}`).then(response => {
            if(response.ok){
                return response.text()
            } else {
                console.error('Failed to delte task');
            }
        }).then(data => {
            document.getElementById('list-group').innerHTML = data
        }).catch(error => console.error('Error updating Task', error))
    }

</script>
<script>
    window.onload = function() {
    const form = document.getElementById('task-form');
    form.onsubmit = function(event) {
        event.preventDefault();

        const formData = new FormData(form);

        fetch("/add", {
            method: "POST",
            body: formData
        })
        .then(response => {
            console.log(response)
            return response.json().then(data => ({ status: response.status, body: data }));
        })
        .then(response => {
            if (response.status === 200 && response.body.success) {
                document.getElementById('list-group').innerHTML = response.body.redirect;
                form.reset()
            } else {
                alert(response.body.message);
                window.location.href = response.body.redirect;
            }
        })
        .catch(error => console.error('Error Adding Task:', error));
    };
};

    function callGenerateDescription(event){
        event.preventDefault();
        const title = document.getElementById("Title").value
        fetch(`/generate_description?title=${title}`)
        .then(response => {
            if (response.status === 400) {
            return response.json().then(data => {
                alert(data.description);
                throw new Error(data.description);
            });
        } else {
            return response.json();
        }
        })
        .then(data => {
            document.getElementById("Description").value = data.description
        }).catch(error => console.error("Error: " , error))
    }
</script>
</html> 