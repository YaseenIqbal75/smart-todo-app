<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO App</title>
</head>
<body>
    <!-- alert modal -->
    <div id="id01" class="w3-modal" >
        <div class="w3-modal-content">
          <div class="w3-container" >
            <h3 id ='reminder'></h3>
            <p id="modalText"></p>
            <span>
                <button class="w3-button w3-green" id="doneButton" style="display: none;">Done</button>
            </span>
            <span>
                <button class="w3-button w3-red" id="notDoneButton" style="display: none;">Not Done</button>
            </span>
        </div>
        </div>
      </div>

    <!--  Welcoming message-->
    <h1>Welcome to Todo App!</h1>

    <!-- Form to Task Info -->
    <div style="border: 1px solid black; width:fit-content;">
    <h3 style="padding: 10px;">Add New Task</h3>
    <form action="/add" method="post">
        <div style="padding: 10px;">
            <label for="Title">Title :</label><br>
            <input type="text" id="Title" name="Title"><br>
            <label for="Description">Description :</label><br>
            <textarea name="Description" id="Description" rows="5" cols="30"></textarea><br>
            <label for="Reminder">Set Reminder:</label><br>
            <input type="datetime-local" id="Reminder" name="Reminder">
            <br><br>
            <input type="submit" value="Add Task">
            <button onclick="callGenerateDescription(event)">Generate Description <b>AI</b></button>
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <ul class="flashes">
                {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %} 
            {% endwith %}

            
        </div>
    </form>
    </div>

    <!-- List of Tasks -->
    <h3>List of Tasks :</h3>
     {% for task in todo_list %}
    <div style="border: 1px solid black; padding: 10px;">
    <p><b>{{task.id}}</b> | {% if task.isComplete%} <s>{{task.title}}</s> {%else%} {{task.title}} {% endif %}</p>
    
    <p><b><i>Description : </i></b> {{task.description}}</p>

    <span><b><i>Status :</i></b></span> 
    {% if task.isComplete == False %}
    
    <span style="color: red;" >Pending</span>
    {% else %}
    <span style="color: green;">Completed</span>
    {% endif %}
    <br><br>
    <a href="/update/{{ task.id }}">Update</a>
    <a href="/delete/{{ task.id }}">Delete</a>
    </div>
    {% endfor %}
</body>

<!-- Javascript Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"> </script>
<script type="text/javascript" charset="utf-8">
    var socket = io('http://127.0.0.1:5000'); // Replace with your server's host and port

    socket.on('connect', function() {
        socket.emit('my_event', {data: 'I\'m connected!'});
    });

    socket.on("alert", function(data){
        console.log("Alert recieved" , data.task_title)
        showModal(data.task_title, data.task_id, data.task_status)
    })

    function showModal(task_title, task_id, task_status){
        if (task_status === false) {
        console.log("showing model")
        document.getElementById('modalText').innerText = `Task: ${task_title}`
        document.getElementById('id01').style.display = 'block'
        let heading = document.getElementById('reminder')
        heading.innerText = "Reminder!"
        heading.style.color = 'Red'
        heading.style.fontWeight = 'bold'
        heading.style.alignSelf= 'center'
        let modal = document.getElementById('id01')
        modal.style.border = '1px solid black'
        modal.style.padding  = '10px'
        modal.style.width = 'fit-content'
        document.getElementById('doneButton').style.display = "inline-block"
        document.getElementById('notDoneButton').style.display = "inline-block"
        const notDoneButton = document.getElementById('notDoneButton')
        const donebutton = document.getElementById('doneButton')
        // notDoneButton.style.display = 'inline-block'
        donebutton.onclick= function(){
            console.log('inside')
            updateTaskStatus(task_id)
            document.getElementById('id01').style.display = 'none'
        }

        notDoneButton.onclick = function(){
            document.getElementById('id01').style.display = 'none'
        }
    }
    }

    function updateTaskStatus(id){
        fetch(`/update/${id}`).then(response => {
            if(response.ok){
                location.reload()
            }
            else{
                console.error('Failed to update task')
            }
        })
        .catch(error=>console.error('Error updating task:', error))
    }
</script>
<script>
    function callGenerateDescription(event){
        event.preventDefault();
        console.log("")
        const title = document.getElementById("Title").value
        fetch(`/generate_description?title=${title}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById("Description").value = data.description
        }).catch(error => console.error("Error: " , error))
    }
</script>
</html> 